<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grupo — EduConnect</title>
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Merriweather:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    body { opacity: 1; }
    .dashboard-header { background: #07142b; padding: 10px 0; }
    .dashboard-nav { display: flex; justify-content: space-between; align-items: center; }
    .dashboard-main { padding: 60px 0; }
    .chat-container { background: white; border-radius: 20px; padding: 20px; }
    .messages-list { max-height: 50vh; overflow-y: auto; margin-bottom: 20px; padding: 10px; display: flex; flex-direction: column; }
    .message { padding: 10px 15px; border-radius: 18px; margin-bottom: 10px; max-width: 70%; width: fit-content; }
    .message.outro { background-color: var(--gray-100); align-self: flex-start; border-bottom-left-radius: 4px; }
    .message.proprio { background-color: rgba(27, 197, 220, 0.2); align-self: flex-end; border-bottom-right-radius: 4px; }
    .message strong { color: var(--navy); font-size: 0.9rem; }
    .message p { margin: 5px 0 0; color: var(--gray-700); white-space: pre-wrap; }
    .message .attachment-link { display: inline-block; margin-top: 5px; font-weight: 500;}
    .message .attachment-image { max-width: 250px; border-radius: 8px; margin-top: 5px; }
  </style>
</head>
<body>
  <header class="dashboard-header">
     <div class="container dashboard-nav">
      <a class="brand" href="dashboard.html" aria-label="EduConnect"><img src="logo-educonnect.png" alt="Logo" style="width:50px; height:auto;"><h1>EduConnect</h1></a>
      <div>
          <a href="grupos.html" class="btn btn-primary">Voltar aos Grupos</a>
          <button id="logout-btn" class="btn btn-outline">Sair</button>
      </div>
    </div>
  </header>
  <main class="dashboard-main">
    <div class="container">
      <h2 id="group-name-title" class="section-title">Carregando grupo...</h2>
      <p id="group-desc-p" style="text-align: center; max-width: 60ch; margin: 8px auto 40px;"></p>
      
      <div class="chat-container">
        <div id="messages-list" class="messages-list"><p>Carregando mensagens...</p></div>
        <hr>
        <form id="new-message-form" class="form" style="margin-top: 20px;">
          <textarea id="message-text" class="input" placeholder="Digite sua mensagem..." style="border-radius: 20px; font-family: Inter, sans-serif;"></textarea>
          <input id="message-attachment" class="input" type="text" placeholder="Cole a URL de uma imagem/arquivo (opcional)">
          <button type="submit" class="btn btn-primary">Enviar</button>
        </form>
      </div>
    </div>
  </main>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const AIRTABLE_TOKEN = "patoWt1Ghg0KNsoHa.0326957161e00f3a0b7e65188f43d77a2d580ca935774b279c74eb192b6405cf"; 
        const AIRTABLE_BASE_ID = "appFKKkbMWXMFHjvD";

        const userEmail = localStorage.getItem('educonnect_useremail');
        if (!userEmail) { window.location.href = 'index.html'; return; }
        
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.clear();
            window.location.href = 'index.html';
        });

        const params = new URLSearchParams(window.location.search);
        const groupId = params.get('id');
        if (!groupId) { window.location.href = 'grupos.html'; return; }

        const gruposUrl = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/Grupos/${groupId}`;
        const mensagensUrl = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/Mensagens`;
        const usuariosUrl = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/Usuarios`;

        const groupNameTitle = document.getElementById('group-name-title');
        const groupDescP = document.getElementById('group-desc-p');
        const messagesList = document.getElementById('messages-list');
        const newMessageForm = document.getElementById('new-message-form');
        
        const carregarDetalhesDoGrupo = async () => {
            try {
                const groupResponse = await fetch(gruposUrl, { headers: { 'Authorization': `Bearer ${AIRTABLE_TOKEN}` } });
                const groupData = await groupResponse.json();
                groupNameTitle.innerText = groupData.fields.NomeDoGrupo;
                groupDescP.innerText = groupData.fields.Descricao;

                // **** LINHA CORRIGIDA ****
                const messagesFilterUrl = `${mensagensUrl}?filterByFormula=FIND('${groupId}', {Grupo} & '')&sort%5B0%5D%5Bfield%5D=Timestamp&sort%5B0%5D%5Bdirection%5D=asc`;
                
                const messagesResponse = await fetch(messagesFilterUrl, { headers: { 'Authorization': `Bearer ${AIRTABLE_TOKEN}` } });
                const messagesData = await messagesResponse.json();

                messagesList.innerHTML = '';
                if (messagesData.records && messagesData.records.length > 0) {
                    for (const record of messagesData.records) {
                        const msg = record.fields;
                        let senderName = 'Usuário Anônimo'; let senderEmail = '';
                        if(msg.EnviadoPor && msg.EnviadoPor[0]) {
                            try {
                                const senderUrl = `${usuariosUrl}/${msg.EnviadoPor[0]}`;
                                const senderResponse = await fetch(senderUrl, { headers: { 'Authorization': `Bearer ${AIRTABLE_TOKEN}` } });
                                const senderData = await senderResponse.json();
                                if(senderData.fields) { senderName = senderData.fields.Nome; senderEmail = senderData.fields.Email; }
                            } catch (e) { console.error("Erro ao buscar nome do remetente", e); }
                        }
                        
                        const messageClass = (senderEmail === userEmail) ? 'proprio' : 'outro';
                        let anexoHTML = '';
                        if (msg.Anexo && msg.Anexo.length > 0) {
                            const anexo = msg.Anexo[0];
                            if (anexo.type && anexo.type.startsWith('image')) {
                                anexoHTML = `<a href="${anexo.url}" target="_blank"><img class="attachment-image" src="${anexo.thumbnails.large.url}" alt="Anexo"></a>`;
                            } else {
                                anexoHTML = `<a href="${anexo.url}" target="_blank" class="attachment-link">Ver anexo: ${anexo.filename}</a>`;
                            }
                        }
                        const messageHTML = `<div class="message ${messageClass}"><strong>${senderName}</strong><p>${msg.Conteudo || ''}</p>${anexoHTML}</div>`;
                        messagesList.innerHTML += messageHTML;
                    }
                } else {
                    messagesList.innerHTML = '<p>Nenhuma mensagem neste grupo ainda. Seja o primeiro a enviar!</p>';
                }
                messagesList.scrollTop = messagesList.scrollHeight;
            } catch (error) {
                console.error("Erro CRÍTICO ao carregar detalhes:", error);
                messagesList.innerHTML = `<p style="color:red;">Ocorreu um erro ao carregar o conteúdo do grupo.</p>`;
            }
        };

        newMessageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const msgText = document.getElementById('message-text').value;
            const msgAttachmentUrl = document.getElementById('message-attachment').value;
            const submitButton = newMessageForm.querySelector('button');
            submitButton.disabled = true;

            try {
                const userFilterUrl = `${usuariosUrl}?filterByFormula=({Email} = '${userEmail}')`;
                const userResponse = await fetch(userFilterUrl, { headers: { 'Authorization': `Bearer ${AIRTABLE_TOKEN}` } });
                const userData = await userResponse.json();
                const userId = userData.records[0].id;

                const newMessageData = { fields: { "Conteudo": msgText, "Grupo": [groupId], "EnviadoPor": [userId] } };
                if (msgAttachmentUrl) { newMessageData.fields.Anexo = [{ url: msgAttachmentUrl }]; }

                const createResponse = await fetch(mensagensUrl, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${AIRTABLE_TOKEN}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ records: [newMessageData] })
                });

                if (!createResponse.ok) {
                    const errorDetails = await createResponse.json();
                    throw new Error(errorDetails.error.message || 'Falha ao enviar mensagem.');
                }
                
                newMessageForm.reset();
                carregarDetalhesDoGrupo();
            } catch(error) {
                console.error("Erro ao enviar mensagem:", error);
                alert(`Não foi possível enviar a mensagem. Detalhe: ${error.message}`);
            } finally {
                submitButton.disabled = false;
            }
        });

        carregarDetalhesDoGrupo();
    });
  </script>
</body>
</html>
